<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Greedy snake</title>
  <style type="text/css">
    * {
      padding: 0;
      margin: 0;
    }
  </style>
</head>
<body>

<canvas id="myCanvas" width="900px" height="900px"></canvas>
<script type="text/javascript">
  let canvas, ctx, canvasWidth, canvasHeight,
      snake = [], //身体数组
      food = {}, //随机生成的子
      direction = 39, //移动方向，默认向右
      myInterval,
      fraction=0 //分数
  ;

  window.onload = function () {
    canvas = document.getElementById('myCanvas');
    //设置背景色
    canvas.style.backgroundColor = '#000';
    canvasWidth = canvas.width;
    canvasHeight = canvas.height;
    ctx = canvas.getContext('2d');


    //监听键盘的上右下左
    document.onkeydown = function (event) {
      var e = event || window.event || arguments.callee.caller.arguments[0];
      if (e && e.keyCode == 40) { //下
        if (direction != 38) direction = 40;
      }
      if (e && e.keyCode == 37) { //左
        if (direction != 39) direction = 37;
      }
      if (e && e.keyCode == 39) { //右
        if (direction != 37) direction = 39;
      }
      if (e && e.keyCode == 38) { // 上
        if (direction != 40) direction = 38;
      }
      // console.log('移动方向：', direction)
    };

    food = new coordinate(random10n(canvasWidth), random10n(canvasHeight));

    init()


    moveSnake()
  }

  //生成初始长度
  function init() {
    snake = [];
    for (let i = 0; i < 18; i++) {
      let coordinate1 = new coordinate(canvasWidth/2 - (i * 10), canvasHeight/2);

      snake.push(coordinate1);
      randomGenerate(coordinate1)
    }
  }

  //移动
  function moveSnake() {
    myInterval = setInterval(() => {
      //清空画布
      ctx.clearRect(0, 0, canvasWidth, canvasHeight);
      //去掉最后一个
      snake.pop()
      let shift = snake[0];
      //移动方向判定,传入蛇头参数
      judgeDirection(shift)
      snake.map((item, index) => {
        randomGenerate(new coordinate(item.x, item.y))
      })
      //吃子判定
      increase();
      //判断是否重合
      generateFood();
      //结束判定
      death();
    }, 50)
  }

  //蛇身增长
  function increase() {
    //获取随机生成子的四个角

    if(ifTouch(food,snake[0])){
      console.log('吃子')
      fraction+=1;
      snake.unshift(food);
    }

    // let foodList=[food,
    //   new coordinate(food.x + 10, food.y),
    //   new coordinate(food.x, food.y + 10),
    //   new coordinate(food.x + 10, food.y + 10)
    // ]
    //
    // foodList.map((item,index)=>{
    //   if(item.x==snake[0].x && item.y==snake[0].y){
    //     console.log('吃子')
    //
    //     snake.unshift(food);
    //
    //     console.log(snake)
    //   }
    // })
  }

  //生成与蛇身不重合的子
  function generateFood() {
    snake.map((item, index) => {
      if (item.x == food.x && item.y == food.y) {
        console.log('重复');
        food = new coordinate(random10n(canvasWidth), random10n(canvasHeight));
        generateFood();
      }
    })

    randomGenerate(new coordinate(food.x, food.y))
    //递归调用
    return;
  }

  //判断移动方向并移动
  function judgeDirection(shift) {
    //判断移动方向
    switch (direction) {
      case 38: //上
        let shifty = shift.y;
        shifty -= 10;
        // console.log(snake)
        snake.unshift(new coordinate(shift.x, shifty))
        break;
      case 40: //下
        let shifty1 = shift.y;
        shifty1 += 10;
        // console.log(snake)
        snake.unshift(new coordinate(shift.x, shifty1))
        break;
      case 37: //左
        let shiftx1 = shift.x;
        shiftx1 -= 10;
        // console.log(snake)
        snake.unshift(new coordinate(shiftx1, shift.y))
        break;
      case 39: //右
        let shiftx = shift.x;
        shiftx += 10;
        // console.log(snake)
        snake.unshift(new coordinate(shiftx, shift.y))
        break;
    }
  }

  //游戏结束判定
  function death() {
    //碰到边界死亡
    if (snake[0].x > canvasWidth  || snake[0].x < 0
        || snake[0].y > canvasHeight  || snake[0].y < 0) {
      end();
    }
    //碰到自己的身体死亡
    for (let i = 4; i < snake.length; i++) {
      // console.log('碰到自己',ifTouch(snake[0], snake[i]))

      if(ifTouch(snake[0], snake[i])) end();
    }
  }

  //判断两个点生成的小正方形是否有重合
  function ifTouch(coordinate1, coordinate2) {

    if(coordinate1.x+10 > coordinate2.x &&
        coordinate1.y+10> coordinate2.y &&
        coordinate2.x+10> coordinate1.x &&
        coordinate2.y+10> coordinate1.y
    ){
      return true;
    }
    return  false;
    // let coordinate1List = [coordinate1,
    //   new coordinate(coordinate1.x + 10, coordinate1.y),
    //   new coordinate(coordinate1.x, coordinate1.y + 10),
    //   new coordinate(coordinate1.x + 10, coordinate1.y + 10)
    // ];
    // let coordinate2List = [coordinate2,
    //   new coordinate(coordinate2.x + 10, coordinate2.y),
    //   new coordinate(coordinate2.x, coordinate2.y + 10),
    //   new coordinate(coordinate2.x + 10, coordinate2.y + 10)
    // ]
    // coordinate1List.map((item, index) => {
    //   coordinate2List.map((item1, index1) => {
    //     if (item.x == item1.x && item.y == item1.y) {
    //       end();
    //     }
    //   })
    // })
  }

  //游戏结束需要进行的一些操作
  function end() {
    clearInterval(myInterval);
    alert(`游戏结束!得分:`+fraction)
    //清空画布
    ctx.clearRect(0, 0, canvasWidth, canvasHeight);
    //初始化
    init()
    //设置移动方向向右
    direction = 39;
    //得分设为0
    fraction=0
    moveSnake()
  }

  //画底
  function bottomDrawing() {
    if (canvas.width > 0 && canvas.height > 0) {
      for (let i = 0; i < canvas.width; i += 10) {
        for (let j = 0; j < canvas.height; j += 10) {
          drawLine(i, j, canvas.width, j);
          drawLine(i, j, i, canvas.height);
        }
      }
    }
  }

  //画直线 x1,y1起点横纵坐标，x2,y2终点横纵坐标
  function drawLine(x1, y1, x2, y2) {
    //开始一条路径
    ctx.beginPath();
    //设置起点
    ctx.moveTo(x1, y1);
    //设置终点
    ctx.lineTo(x2, y2);
    //设置颜色
    ctx.strokeStyle = "green";
    //设置线条宽度
    ctx.lineWidth = 1;
    //闭合路径
    ctx.closePath();
    //渲染绘制
    ctx.stroke();
  }

  //画一个正方形
  function randomGenerate(coordinate) {
    ctx.fillStyle = '#fff';
    ctx.fillRect(coordinate.x, coordinate.y, 10, 10);
  }

  //随机生成一个10的倍数
  function random10n(n) {
    let inum = parseInt(Math.floor(n / 10));
    if (n == 0) {
      return 0;
    }
    //如果不等于0则返回一个这个数的随机数，然后乘以8.
    return parseInt(GetRandomInt(inum) * 10);
  }

  function GetRandomInt(n) {
    return parseInt(Math.floor(Math.random() * n));
  }

  //坐标类
  class coordinate {
    constructor(x, y) {
      this.x = x;
      this.y = y;
    }
  }
</script>
</body>
</html>